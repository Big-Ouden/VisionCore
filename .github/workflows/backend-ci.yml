name: Backend CI

on:
  push:
    branches: 
      - main
      - dev
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: 
      - main
      - dev
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  workflow_dispatch:

jobs:
  cppcheck:
    name: Run cppcheck on backend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libopencv-dev \
          qtbase5-dev \
          libgtest-dev \
          nlohmann-json3-dev

    - name: Configure CMake
      run: |
        cd backend
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd backend/build
        make -j$(nproc)

    - name: Run tests
      run: |
        cd backend/build
        ctest --output-on-failure --verbose

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: backend/build/Testing/Temporary/

  code-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libopencv-dev \
          qtbase5-dev \
          libgtest-dev \
          nlohmann-json3-dev \
          lcov

    - name: Configure CMake with coverage
      run: |
        cd backend
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_C_FLAGS="--coverage"

    - name: Build
      run: |
        cd backend/build
        make -j$(nproc)

    - name: Run tests
      run: |
        cd backend/build
        ctest --output-on-failure

    - name: Generate coverage
      run: |
        cd backend/build
        lcov --capture \
          --directory . \
          --output-file coverage.info \
          --rc geninfo_unexecuted_blocks=1 \
          --ignore-errors inconsistent,mismatch,negative \
          --quiet
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/build/_deps/*' \
          --output-file coverage.info \
          --ignore-errors inconsistent \
          --quiet
        lcov --list coverage.info
        genhtml coverage.info --output-directory coverage_html

    - name: Extract coverage summary
      working-directory: backend/build
      run: |
        echo "# Code Coverage Report" > coverage_summary.md
        echo "" >> coverage_summary.md
        echo "Generated on: $(date)" >> coverage_summary.md
        echo "" >> coverage_summary.md
        echo "\`\`\`" >> coverage_summary.md
        lcov --list coverage.info >> coverage_summary.md
        echo "\`\`\`" >> coverage_summary.md
        
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          backend/build/coverage.info
          backend/build/coverage_html/
          backend/build/coverage_summary.md
        retention-days: 30

  static-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=warning,style,performance,portability \
          --suppress=missingIncludeSystem \
          --suppress=missingInclude \
          --suppress=unusedFunction \
          --inline-suppr \
          --quiet \
          -I backend/src \
          backend/src/*.cpp \
          backend/src/*/*.cpp \
          backend/src/*/*.hpp

    - name: Check results
      if: failure()
      run: echo "Static analysis found issues"
