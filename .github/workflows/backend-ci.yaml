name: backend-ci

on:
  push:
    paths:
      - 'backend/**'
  pull_request:
    paths:
      - 'backend/**'

jobs:
  cppcheck:
    name: Run cppcheck on backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck from backend
        run: |
          set -euo pipefail

          if [ ! -d backend ]; then
            echo "No backend directory found; skipping cppcheck."
            exit 0
          fi

          cd backend

          echo "Collecting source and header files..."
          # Count files to decide whether to run cppcheck
          files_count=$(find . -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.h' -o -name '*.hpp' \) | wc -l)

          if [ "${files_count:-0}" -eq 0 ]; then
            echo "No source/header files found in backend; skipping cppcheck."
            exit 0
          fi

          # If an include directory exists in backend, use it for includes
          inc_arg=""
          if [ -d include ]; then
            inc_arg="-I include"
            echo "Detected backend/include, adding include path: include"
          fi

          # Use find + xargs -0 to avoid issues with shell globbing/expansion and filenames with spaces
          find . -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.h' -o -name '*.hpp' \) -print0 |
            xargs -0 --no-run-if-empty cppcheck --enable=all ${inc_arg} -j2 --quiet
